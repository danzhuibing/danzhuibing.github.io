<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="刚出道的大数据分析师">
<meta property="og:type" content="website">
<meta property="og:title" content="三行代码">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="三行代码">
<meta property="og:description" content="刚出道的大数据分析师">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="三行代码">
<meta name="twitter:description" content="刚出道的大数据分析师">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 三行代码 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">三行代码</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-heartbeat fa-fw"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/20/Python工具箱：日志与配置文件/" itemprop="url">
                  Python工具箱：日志与配置文件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-20T16:17:49+08:00" content="2015-12-20">
              2015-12-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/程序员工具箱/" itemprop="url" rel="index">
                    <span itemprop="name">程序员工具箱</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上班以来，负责了两个独立的Python工程，一个是为清华合作单位做的GPS点道路匹配的Hadoop Streaming程序，一个是为交通预测项目做的进行在线预测的Spark程序，开发语言都是Python。其中用了同事提供的两个脚本实现了日志和配置文件，感觉非常方便，因此写出来，方便自己以后使用，也分享给其他感兴趣的朋友。用到了一些别人的代码，表示感谢。如果觉得侵权，请联系我，立刻删除。</p>
<h1 id="代码准备"><a href="#代码准备" class="headerlink" title="代码准备"></a>代码准备</h1><p>首先，拷贝以下几个代码文件。</p>
<h2 id="日志logger-py"><a href="#日志logger-py" class="headerlink" title="日志logger.py"></a>日志<strong>logger.py</strong></h2><p>作者是百度的裴欣，感谢他的代码，尽管我和他并不相识</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*-coding:gbk-*-</span></span><br><span class="line"><span class="string">"""</span><br><span class="line">实现log相关功能,分级和输出形式模仿了ullog样式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">******************使用方法*********华丽的分割线***********</span><br><span class="line">import logger</span><br><span class="line"></span><br><span class="line"># 初始化，输出DEUBG及以上级别的日志</span><br><span class="line"># DEBUG, TRACE和NOTICE结果打在/log/a.log文件中</span><br><span class="line"># WARNING和FATAL结果打在/log/a.log.wf文件中</span><br><span class="line">logger.init('/log/a', 'DEBUG')</span><br><span class="line"></span><br><span class="line"># 如果不做初始化，则会直接打在标准错误</span><br><span class="line"></span><br><span class="line"># 打DEBUG日志</span><br><span class="line">logger.debug_log('sdlksdlks')</span><br><span class="line"></span><br><span class="line"># 打FATAL日志</span><br><span class="line">logger.fatal_log('ksldsll')</span><br><span class="line"></span><br><span class="line"># 其他级别log类似</span><br><span class="line"></span><br><span class="line">"""</span></span><br><span class="line">__authors__ = [<span class="string">'裴欣&lt;peixin@baidu.com&gt;'</span>, ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> handlers</span><br><span class="line"></span><br><span class="line">logging.TRACE = <span class="number">15</span></span><br><span class="line">logging.addLevelName(logging.TRACE, <span class="string">'TRACE'</span>)</span><br><span class="line">logging.NOTICE = logging.INFO</span><br><span class="line">logging.addLevelName(logging.NOTICE, <span class="string">"NOTICE"</span>)</span><br><span class="line">logging.FATAL = logging.ERROR</span><br><span class="line">logging.addLevelName(logging.FATAL, <span class="string">'FATAL'</span>)</span><br><span class="line"></span><br><span class="line">log_level_dict = &#123;<span class="string">'DEBUG'</span>:<span class="number">10</span>, <span class="string">'TRACE'</span>:<span class="number">15</span>, <span class="string">'NOTICE'</span>:<span class="number">20</span>, <span class="string">'WARNING'</span>:<span class="number">30</span>, <span class="string">'FATAL'</span>:<span class="number">40</span>&#125;</span><br><span class="line">formatter = logging.Formatter(<span class="string">'%(levelname)s: %(asctime)s: %(message)s'</span>, datefmt=<span class="string">'%m-%d %H:%M:%S'</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">class LoggerState(object):</span><br><span class="line">    def __init__():</span><br><span class="line">        "disable the __init__ method"</span><br><span class="line"></span><br><span class="line">    __instance = None</span><br><span class="line">    __lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def has_initialized():</span><br><span class="line">        LoggerState.__lock.acquire()</span><br><span class="line">        result = True</span><br><span class="line">        if None == LoggerState.__instance:</span><br><span class="line">            LoggerState.__instance = object.__new__(LoggerState)</span><br><span class="line">            result = False</span><br><span class="line">        LoggerState.__lock.release()</span><br><span class="line">        return result</span><br><span class="line">"""</span></span><br><span class="line">__initialized = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">__normal_logger = logging.getLogger(<span class="string">'normal'</span>)</span><br><span class="line">__wf_logger = logging.getLogger(<span class="string">'wf'</span>)</span><br><span class="line"><span class="comment">#if not LoggerState.has_initialized():</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> __initialized:</span><br><span class="line">    __normal_handler = logging.StreamHandler()</span><br><span class="line">    __normal_handler.setFormatter(formatter)</span><br><span class="line">    __normal_logger = logging.getLogger(<span class="string">'normal'</span>)</span><br><span class="line">    __normal_logger.addHandler(__normal_handler)</span><br><span class="line">    __normal_logger.setLevel(<span class="number">0</span>)</span><br><span class="line">    __wf_handler = logging.StreamHandler()</span><br><span class="line">    __wf_handler.setFormatter(formatter)</span><br><span class="line">    __wf_logger = logging.getLogger(<span class="string">'wf'</span>)</span><br><span class="line">    __wf_logger.addHandler(__wf_handler)</span><br><span class="line">    __wf_logger.setLevel(logging.WARNING)</span><br><span class="line">    __initialized = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">(log_file, log_level=<span class="string">'NOTICE'</span>)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> __normal_handler</span><br><span class="line">    <span class="keyword">global</span> __wf_handler</span><br><span class="line">    <span class="keyword">global</span> __normal_logger</span><br><span class="line">    <span class="keyword">global</span> __wf_logger</span><br><span class="line"></span><br><span class="line">    log_dir = os.path.dirname(log_file)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">        os.makedirs(log_dir)</span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(log_dir):</span><br><span class="line">        <span class="keyword">raise</span> IOException(<span class="string">'the path [%s] is regular file but not a dir'</span>%(log_dir))</span><br><span class="line"></span><br><span class="line">    real_log_level = log_level_dict.get(log_level, <span class="number">20</span>)</span><br><span class="line">    __normal_logger.removeHandler(__normal_handler)</span><br><span class="line">    __normal_handler = logging.handlers.WatchedFileHandler(<span class="string">'%s.log'</span>%(log_file))</span><br><span class="line">    __normal_handler.setFormatter(formatter)</span><br><span class="line">    __normal_logger = logging.getLogger(<span class="string">'normal'</span>)</span><br><span class="line">    __normal_logger.addHandler(__normal_handler)</span><br><span class="line">    __normal_logger.setLevel(real_log_level)</span><br><span class="line"></span><br><span class="line">    __wf_logger.removeHandler(__wf_handler)</span><br><span class="line">    __wf_handler = logging.handlers.WatchedFileHandler(<span class="string">'%s.log.wf'</span>%(log_file))</span><br><span class="line">    __wf_handler.setFormatter(formatter)</span><br><span class="line">    __wf_logger = logging.getLogger(<span class="string">'wf'</span>)</span><br><span class="line">    __wf_logger.addHandler(__wf_handler)</span><br><span class="line">    __wf_logger.setLevel(logging.WARNING)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">()</span>:</span></span><br><span class="line">    __normal_handler.flush()</span><br><span class="line">    __normal_handler.close()</span><br><span class="line"></span><br><span class="line">    __wf_handler.flush()</span><br><span class="line">    __wf_handler.close()</span><br><span class="line"></span><br><span class="line">    logging.shutdown()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__get_call_func_frame_info</span><span class="params">()</span>:</span></span><br><span class="line">    frame = inspect.getouterframes(inspect.currentframe())[<span class="number">2</span>]</span><br><span class="line">    frame_info = inspect.getframeinfo(frame[<span class="number">0</span>])</span><br><span class="line">    info = <span class="string">'[%s][%d][%s]'</span>%(frame_info.filename, frame_info.lineno, frame_info.function)</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">warning_log</span><span class="params">(info)</span>:</span></span><br><span class="line">    stack_info = __get_call_func_frame_info()</span><br><span class="line">    __wf_logger.warning(<span class="string">'%s %s'</span>%(stack_info, info))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fatal_log</span><span class="params">(info)</span>:</span></span><br><span class="line">    stack_info = __get_call_func_frame_info()</span><br><span class="line">    __wf_logger.log(logging.FATAL, <span class="string">'%s %s'</span>%(stack_info, info))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notice_log</span><span class="params">(info)</span>:</span></span><br><span class="line">    stack_info = __get_call_func_frame_info()</span><br><span class="line">    __normal_logger.log(logging.NOTICE, <span class="string">'%s %s'</span>%(stack_info, info))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trace_log</span><span class="params">(info)</span>:</span></span><br><span class="line">    stack_info = __get_call_func_frame_info()</span><br><span class="line">    __normal_logger.log(logging.TRACE, <span class="string">'%s %s'</span>%(stack_info, info))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug_log</span><span class="params">(info)</span>:</span></span><br><span class="line">    stack_info = __get_call_func_frame_info()</span><br><span class="line">    __normal_logger.debug(<span class="string">'%s %s'</span>%(stack_info, info))</span><br></pre></td></tr></table></figure>
<h2 id="配置read-conf-py"><a href="#配置read-conf-py" class="headerlink" title="配置read_conf.py"></a>配置<strong>read_conf.py</strong></h2><p>作者不详，送出不明方向的祝福。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*-coding:gbk-*-</span></span><br><span class="line"><span class="string">"""</span><br><span class="line">提供了从python文件中读取配置的简单检查函数</span><br><span class="line">"""</span></span><br><span class="line"><span class="keyword">import</span> imp</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_float</span><span class="params">(value, min=sys.float_info.min, max=sys.float_info.max)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    检查一个值的类型是否是浮点数</span><br><span class="line">    并检查值是否正常</span><br><span class="line">    """</span></span><br><span class="line">    <span class="keyword">if</span> type(value) != types.FloatType <span class="keyword">and</span> type(value) != types.IntType:</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"type of [%s] is not float"</span>%(value))</span><br><span class="line">    <span class="keyword">if</span> value &lt; min <span class="keyword">or</span> value &gt; max:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"invalid value [%d]"</span>%(value))</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_int</span><span class="params">(value, min = -sys.maxint - <span class="number">1</span>, max=sys.maxint )</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    检查一个值的类型是否是整数</span><br><span class="line">    并检查值是否正常</span><br><span class="line">    """</span></span><br><span class="line">    <span class="keyword">if</span> type(value) != types.IntType:</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"type of [%s] is not int"</span>%(value))</span><br><span class="line">    <span class="keyword">if</span> value &lt; min <span class="keyword">or</span> value &gt; max:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"invalid value [%d]"</span>%(value))</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_str</span><span class="params">(value)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    检查一个值的类型是否是字符串</span><br><span class="line">    """</span></span><br><span class="line">    <span class="keyword">if</span> type(value) != types.StringType:</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"type of [%s] is not string"</span>%(value))</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_list</span><span class="params">(value, min_size=<span class="number">0</span>, max_size=sys.maxint, item_type=None)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    检查一个值的类型是否是list</span><br><span class="line">    同时对list的size进行检查</span><br><span class="line">    是否小于最小size或者大于最大size</span><br><span class="line">    如果item_type不是None，则对list中每个元素的类型进行检查</span><br><span class="line">    要求list中每个元素的类型都要符合要求</span><br><span class="line">    """</span></span><br><span class="line">    <span class="keyword">if</span> type(value) != types.ListType:</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"type of [%s] is not list"</span>%(value))</span><br><span class="line">    <span class="keyword">if</span> len(value) &lt; min_size <span class="keyword">or</span> len(value) &gt; max_size:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"the length of input list is invalid"</span>)</span><br><span class="line">    <span class="keyword">if</span> item_type != <span class="keyword">None</span>:</span><br><span class="line">        <span class="keyword">if</span> any([type(item)!=item_type <span class="keyword">for</span> item <span class="keyword">in</span> value]):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"the type of all the element must be [%s]"</span>%(item_type))</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_conf_module</span><span class="params">(conf_path)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(conf_path):</span><br><span class="line">        logger.fatal_log(<span class="string">'conf file [%s] does not exist'</span>%(conf_path))</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'conf file [%s] does not exist'</span>%(conf_path))</span><br><span class="line">    path_split = os.path.split(conf_path)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        conf_module = imp.load_source(path_split[<span class="number">1</span>], conf_path)</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        logger.fatal_log(<span class="string">'can not load the config file [%s] because [%s]'</span>%(conf_path, e))</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'can not load the config file [%s]'</span>%(conf_path))</span><br><span class="line">    <span class="keyword">return</span> conf_module</span><br></pre></td></tr></table></figure>
<h1 id="构建自己的应用"><a href="#构建自己的应用" class="headerlink" title="构建自己的应用"></a>构建自己的应用</h1><p>首先，设计自己程序需要配置的参数， 文件名假设为<strong>conf.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ODPS_PATH=<span class="string">"XXXXXX"</span></span><br><span class="line">INPUT_PROJECT=<span class="string">"XXXXX"</span></span><br><span class="line">INPUT_TABLES=[<span class="string">"XXXXXX"</span>]</span><br><span class="line">OUTPUT_PROJECT=<span class="string">"XXXXXX"</span></span><br><span class="line">OUTPUT_TABLES=[<span class="string">"XXXXX"</span>]</span><br><span class="line">BIN_NAME=<span class="string">"XXXXX"</span></span><br><span class="line">MAP_HOME=<span class="string">"XXXXXX"</span></span><br><span class="line">MAP_VERSION=<span class="string">"XXXXX"</span></span><br><span class="line">ADCODE=<span class="string">"XXXXX"</span></span><br><span class="line">MONTH=<span class="string">"XXXXX"</span></span><br></pre></td></tr></table></figure>
<p>然后写主程序，文件名假设为<strong>test.py</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> read_conf</span><br><span class="line"><span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> optparse <span class="keyword">import</span> OptionParser</span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_conf</span><span class="params">(conf_name)</span>:</span> </span><br><span class="line"><span class="comment">#conf_name为配置文件的地址，返回字典，保存配置文件的信息</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        conf_module = read_conf.get_conf_module(conf_name)</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        logger.fatal_log(<span class="string">'cannot load the config file [%s] because [%s]'</span> % (conf_name, e))</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'cannot load the config file [%s]'</span> % (conf_name))</span><br><span class="line">    result = &#123;&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result[<span class="string">'odps_path'</span>] = read_conf.get_str(conf_module.ODPS_PATH)</span><br><span class="line">        result[<span class="string">'input_project'</span>] = read_conf.get_str(conf_module.INPUT_PROJECT)</span><br><span class="line">        result[<span class="string">'input_tables'</span>] = read_conf.get_list(conf_module.INPUT_TABLES, <span class="number">1</span>, types.StringType)</span><br><span class="line">        result[<span class="string">'output_project'</span>] = read_conf.get_str(conf_module.OUTPUT_PROJECT)</span><br><span class="line">        result[<span class="string">'output_tables'</span>] = read_conf.get_list(conf_module.OUTPUT_TABLES, <span class="number">1</span>, types.StringType)</span><br><span class="line">        result[<span class="string">'bin_name'</span>] = read_conf.get_str(conf_module.BIN_NAME)</span><br><span class="line">        result[<span class="string">'map_home'</span>] = read_conf.get_str(conf_module.MAP_HOME)</span><br><span class="line">        result[<span class="string">'map_version'</span>] = read_conf.get_str(conf_module.MAP_VERSION)</span><br><span class="line">        result[<span class="string">'adcode'</span>] = read_conf.get_str(conf_module.ADCODE)</span><br><span class="line">        result[<span class="string">'month'</span>] = read_conf.get_str(conf_module.MONTH)</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        logger.fatal_log(<span class="string">'failed to read conf [%s]'</span>%(e))</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    usage_string = <span class="string">"usage: python %prog [options] arg"</span></span><br><span class="line">    parser = OptionParser(usage=usage_string)</span><br><span class="line">    parser.add_option(<span class="string">'-c'</span>, dest=<span class="string">'conf'</span>, default=<span class="keyword">None</span>, help=<span class="string">'read conf here'</span>)</span><br><span class="line">    (options, args) = parser.parse_args()</span><br><span class="line">    <span class="keyword">if</span> options.conf == <span class="keyword">None</span>:</span><br><span class="line">        logger.fatal_log(<span class="string">" -c parameter must be specified. See help for more information."</span>)</span><br><span class="line">        sys.exit(<span class="number">-1</span>)</span><br><span class="line">    home = os.path.dirname(sys.path[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.init(<span class="string">'%s/log/log_%s'</span>%(home,options.posix), <span class="string">'NOTICE'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        logger.fatal_log(<span class="string">' failed to create log'</span>)</span><br><span class="line">        sys.exit(<span class="number">-1</span>)</span><br><span class="line">    conf = get_conf(options.conf)</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/20/C工具箱：Makefile/" itemprop="url">
                  C工具箱：Makefile
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-20T09:31:54+08:00" content="2015-12-20">
              2015-12-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/程序员工具箱/" itemprop="url" rel="index">
                    <span itemprop="name">程序员工具箱</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>关于Makefile有几个知识点：</p>
<p>$(wildcard .cpp)：展开获得路径下所有以.cpp结尾的文件名</p>
<p>OBJS = /$(SRCS:.c=.o)：把SRCS中的.c换成.o，赋值给OBJS</p>
<p>$@表示目标</p>
<p>$^表示所有依赖</p>
<p>$&lt;表示第一个依赖文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">CC=gcc</span><br><span class="line">CXX=g++</span><br><span class="line">INCLUDE=-I./</span><br><span class="line">LDFLAGS=-lcurl ./Decoder/release/Decoder.a </span><br><span class="line"></span><br><span class="line">MAKER_SRCS=$(wildcard *.cpp)</span><br><span class="line">MAKER_OBJS=$(MAKER_SRCS:.cpp=.o)</span><br><span class="line">TARGET=ProgramName</span><br><span class="line"></span><br><span class="line">.PHONY:all</span><br><span class="line">all: $(TARGET)</span><br><span class="line"></span><br><span class="line">$(TARGET):$(MAKER_OBJS)</span><br><span class="line">        @echo &apos;Building target: $@&apos;</span><br><span class="line">        $(CXX) -o $@ $^  $(LDFLAGS)</span><br><span class="line"></span><br><span class="line">%.o:%.cpp</span><br><span class="line">        $(CXX) $(INCLUDE) -o $@ -c $&lt;</span><br><span class="line"></span><br><span class="line">.PHONY:clean</span><br><span class="line">clean:</span><br><span class="line">        rm -f $(TARGET) $(MAKER_OBJS)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/19/Python工具箱：与外部程序管道交互/" itemprop="url">
                  Python工具箱：与外部程序管道交互
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-19T08:56:02+08:00" content="2015-12-19">
              2015-12-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/程序员工具箱/" itemprop="url" rel="index">
                    <span itemprop="name">程序员工具箱</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>假设外部有一个streaming风格的程序decode，即输入从stdin读取，输出写到stdout。现在想用python调用它，可以采用os模块的popen2（已不推荐）或者subprocess模块的Popen。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys,os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="comment">#首先，用python构造出decode需要的输入content</span></span><br><span class="line">content = <span class="string">"XXXXXX"</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment">#pipe_in, pipe_out = os.popen2("./decode", "wr")</span></span><br><span class="line">    <span class="comment">#pipe_in.write(content)</span></span><br><span class="line">    <span class="comment">#pipe_in.close()</span></span><br><span class="line">    <span class="comment">#ret = pipe_out.readline()</span></span><br><span class="line">    <span class="comment">#pipe_out.close()</span></span><br><span class="line">    cur_dir = sys.path[<span class="number">0</span>]</span><br><span class="line">    p = subprocess.Popen(<span class="string">"%s/KeyPoints2ConLinks"</span>%cur_dir, stdin = subprocess.PIPE, stdout = subprocess.PIPE, shell = <span class="keyword">True</span>)  </span><br><span class="line">    p.stdin.write(content)</span><br><span class="line">    (ret,erroutput) = p.communicate()</span><br><span class="line">    <span class="keyword">if</span> ret:</span><br><span class="line">        <span class="keyword">print</span> ret,</span><br><span class="line"><span class="keyword">except</span> Exception, e:</span><br><span class="line">    <span class="keyword">print</span> &gt;&gt; sys.stderr, <span class="string">"error with Exception [%s]"</span> % e</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/14/我和同学关于工业4.0的讨论/" itemprop="url">
                  我和同学关于工业4.0的讨论
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-14T23:28:03+08:00" content="2015-12-14">
              2015-12-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/杂谈/" itemprop="url" rel="index">
                    <span itemprop="name">杂谈</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>有个高中同学最近给我发了个微信，让我讲讲什么是工业4.0，可能是觉得我去德国学了一年机械，多少应该会有些了解。这同学问的还挺有水平，着实把我问住了：</p>
<ul>
<li>从工业3.0到工业4.0，是要改变什么？</li>
<li>实现工业4.0，对于产业链下游的客户能得到什么？对于生产企业自己本身能得到什么？</li>
<li>工业4.0最重要的是工厂和设备的互联，这个互联主要的作用是收集和共享数据吗？这些数据搜集来后主要用来决策什么东西，可以理解为更智能的ERP系统吗？或者说是具有大数据功能的ERP系统？</li>
<li>国内制造业适不适合搞工业互联网？实现工业4.0需要依赖哪些技术？</li>
</ul>
<h2 id="工业4-0的概念解读"><a href="#工业4-0的概念解读" class="headerlink" title="工业4.0的概念解读"></a>工业4.0的概念解读</h2><p>首先，我们要明白为什么是4.0。这就涉及到德国人眼中的工业革命。<br><img src="http://ww1.sinaimg.cn/mw690/6fb7db43jw1ez0p8pyoh7j20pe0hi7cg.jpg" alt="" title="出处：德国亚琛工业大学机床研究所WZL&amp;Fraunhof IPT"></p>
<ul>
<li><strong>工业1.0</strong>：发明蒸汽机，人制造机器==&gt;人操作机器制造机器</li>
<li><strong>工业2.0</strong>：发明流水线，人操作机器制造机器==&gt;人操作机器制造机器的一部分</li>
<li><strong>工业3.0</strong>：发明PLC和六轴机器人，人操作机器制造机器的一部分==&gt;人编写程序，让机器操作机器制造机器[的一部分]</li>
<li><strong>工业4.0</strong>：发明互联网，机器操作机器制造机器[的一部分]==&gt;？</li>
</ul>
<h2 id="互联网改变了什么"><a href="#互联网改变了什么" class="headerlink" title="互联网改变了什么"></a>互联网改变了什么</h2><p>互联网创造了新的生活方式：</p>
<ul>
<li><strong>门户网站</strong>：搜狐</li>
<li><strong>搜索引擎</strong>：百度</li>
<li><strong>社交网站</strong>：QQ，微信</li>
<li><strong>电商</strong>：淘宝，京东</li>
<li><strong>游戏</strong>：腾讯，网易</li>
<li><strong>视频</strong>：优酷</li>
<li><strong>社交网站</strong>：微博、Facebook</li>
<li><strong>工具</strong>：高德地图、360</li>
</ul>
<p>互联网改变了传统行业：</p>
<ul>
<li><strong>用车</strong>：滴滴出行</li>
<li><strong>洗衣</strong>：e袋洗</li>
<li><strong>外卖</strong>：饿了么</li>
<li><strong>看电影</strong>：美团</li>
<li><strong>金融</strong>：支付宝</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/12/ZooKeeper资料汇总/" itemprop="url">
                  ZooKeeper资料汇总
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-12T16:04:21+08:00" content="2015-12-12">
              2015-12-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/大数据基础/" itemprop="url" rel="index">
                    <span itemprop="name">大数据基础</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>网上有许多关于ZooKeeper的资料，为我们深入学习创造了良好的条件。本文的目的是把这些资料整理到一块，方便零基础的同学了解ZooKeeper的绝大部分知识。</p>
<p>第一部分：讲解ZooKeeper的功能，分布式协调，帮助大家理解协调的概念。</p>
<p>第二部分：讲解ZooKeeper的使用场景，方便大家做技术选型。</p>
<p>第三部分：讲解ZooKeeper的内部实现细节，包括ZooKeeper的议会运转方式，选主算法，Observer与ZK的扩展性，Follower与Leader的读写处理流程。</p>
<p>第四部分：讲解ZooKeeper的客户端API，方便进行基于ZooKeeper的分布式系统开发。</p>
<h2 id="ZooKeeper是什么"><a href="#ZooKeeper是什么" class="headerlink" title="ZooKeeper是什么"></a>ZooKeeper是什么</h2><blockquote>
<p>参考来源：<a href="http://www.cnblogs.com/yuyijq/p/3391945.html" target="_blank" rel="external">http://www.cnblogs.com/yuyijq/p/3391945.html</a></p>
</blockquote>
<p>Google的三篇论文奠定了大数据和云计算的基础，于是在开源界有了HDFS、MapReduce和HBase。值得注意的是，Google的三篇论文都提到了一个锁服务Chubby，于是对应的在开源界我们有了ZooKeeper。</p>
<blockquote>
<p>ZooKeeper is a service for coordinating processes of distributed applications</p>
</blockquote>
<p>“分布式协调服务”，这是ZooKeeper的定位。码农们对协调这个高雅的词汇总是感觉到云蒸雾罩，其实说成大白话，就是并发环境下的锁机制。</p>
<p>不管使用哪种编程语言，基本上都可以找到完善的锁方案。然而分布式协调比同一个进程里的协调复杂得多，复杂的原因是网络是不可靠的。ZooKeeper是分布式协调的基础服务，久经考验。</p>
<h2 id="ZooKeeper可以干什么"><a href="#ZooKeeper可以干什么" class="headerlink" title="ZooKeeper可以干什么"></a>ZooKeeper可以干什么</h2><blockquote>
<p>参考来源：<a href="http://www.open-open.com/lib/view/open1415453633887.html" target="_blank" rel="external">http://www.open-open.com/lib/view/open1415453633887.html</a></p>
</blockquote>
<h3 id="ZooKeeper的数据模型"><a href="#ZooKeeper的数据模型" class="headerlink" title="ZooKeeper的数据模型"></a>ZooKeeper的数据模型</h3><p>ZooKeeper=文件系统+通知机制</p>
<p><img src="http://s1.sinaimg.cn/large/0022QsiTzy6POfi5sCQf0" alt="出处：http://www.open-open.com/lib/view/open1415453633887.html" title="出处：http://www.open-open.com/lib/view/open1415453633887.html"></p>
<p>上面这张图是理解ZooKeeper的关键，既展现了ZooKeeper内置的数据结构，又展现了典型应用场景。ZooKeeper内部实现了一个类似文件系统的树结构，每个节点被称为znode。znode可以看做是文件系统的中文件夹+文件。说它是文件夹，因为它下面可以放子节点；说它是文件，因为它本身存储了数据。</p>
<p>每个znode可以被客户端注册监听，当znode发生变化（存储的数据发生改变、被删除、子节点增加和删除时），ZooKeeper会通知客户端。</p>
<h3 id="ZooKeeper的典型应用场景"><a href="#ZooKeeper的典型应用场景" class="headerlink" title="ZooKeeper的典型应用场景"></a>ZooKeeper的典型应用场景</h3><h4 id="命名服务"><a href="#命名服务" class="headerlink" title="命名服务"></a>命名服务</h4><p>对应上图的NameService。只要在ZooKeeper的文件系统里创建一个znode，就能获得唯一的path。这个path就能作为一个名称。</p>
<h4 id="配置管理，又称为数据发布与订阅"><a href="#配置管理，又称为数据发布与订阅" class="headerlink" title="配置管理，又称为数据发布与订阅"></a>配置管理，又称为数据发布与订阅</h4><p>对应数据模型的Configuration节点。</p>
<p><img src="http://s3.sinaimg.cn/large/0022QsiTzy6POfSmkLg92" alt="" title="出处：http://www.open-open.com/lib/view/open1415453633887.html"></p>
<p>一般而言，应用程序=代码+配置。单机时，往往给程序设立一个配置文件，代码内部读取配置文件。由于配置文件不常修改，且数量少，所以是个好办法。然而当配置文件很多，许多服务器都需要这些相同的配置，且配置文件需要动态修改时，在每个服务器上都单独建立配置文件的维护运营成本太高。因此我们考虑采用集中管理配置，在集中的位置修改配置，所有对配置感兴趣的服务器都可以获得变更，如上图所示。为了提高集中管理的可靠性，我们一般用一个集群来提供配置服务，所以ZooKeeper往往是一个集群。既然是集群，就涉及到如何保证集群中不同机器的一致性。这个问题在ZooKeeper中得到了很好的解决，后面再进行详解。</p>
<p>具体示例：a）应用中用到的一些配置信息集中管理，在应用启动的时候主动来获取一次，并且在节点上注册一个Watcher，以后每次配置有更新，实时通知到应用，获取最新配置信息；b）业务逻辑中需要用到的一些全局变量，比如一些消息中间件的消息队列通常有个offset，这个offset存放在zk上，这样集群中每个发送者都能知道当前的发送进度。</p>
<h4 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h4><p>对应于数据模型中的GroupMembers节点。<br><img src="http://s6.sinaimg.cn/large/0022QsiTzy6POgByhQV55" alt="此处输入图片的描述" title="出处：http://www.open-open.com/lib/view/open1415453633887.html"></p>
<p>集群管理，主要是两点：一是机器的加入和退出，二是选举master。</p>
<p>机器加入和退出：所有的机器作为client，在目录GroupMembers下创建临时目录节点，然后监听GroupMembers的子节点变化消息。当一个机器挂掉的时候，该机器与ZooKeeper断开了连接，ZooKeeper会自动删除该机器创建的临时目录节点，并通知所有其他的机器。新机器加入，会创建它的临时目录节点，GroupMembers发生状态改变，于是ZooKeeper的通知机制会让所有注册了的client获得该信息。能够实时知道机器的增减情况后，就可以做些后续处理，做成监控系统了。</p>
<p><strong>Master选举</strong>：ZooKeeper最经典的使用场景。ZooKeeper具有最终一致性，即多个Client请求创建/CurrentMaster节点，最终一定只有一个客户端请求能够创建成功。</p>
<p>参照机器加入和退出，也可以实现动态Master选举。首先让Client在目录CurrentMaster下创建临时目录节点，节点存储了一个编号。每次选择编号最小的作为master。当当前master挂掉后，立马选择下一个最小编号的作为master。</p>
<h4 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h4><p>锁服务分为两类，一个是保持独占，另一个是控制时序。</p>
<p><strong>保持独占</strong>：把一个znode看做是一把锁，让客户端都去创建/distribute_lock节点，最终成功创建的那个客户端就拥有了这把锁。用完后删除掉自己创建的distribute_lock节点，释放锁。</p>
<p><strong>控制时序</strong>：/distribute_lock已经创建，所有客户端在它下面创建临时有序节点，编号最小的获得锁，用完之后节点自动删除，下一个获得锁。</p>
<h4 id="分布式通知-协调"><a href="#分布式通知-协调" class="headerlink" title="分布式通知/协调"></a>分布式通知/协调</h4><p>ZooKeeper中的通知机制，能够很好地实现分布式环境下不同系统之间的通知与协调，实现对数据变更的实时处理。使用方法是不同的系统都对ZooKeeper上同一个znode进行注册，监听znode的变化（包括znode存储的信息与子节点信息），其中一个系统更新了znode，那么另一个系统能够收到通知，并做出相应处理。</p>
<p>因此ZooKeeper可以用作另外一种心跳检测机制：检测系统和被检测系统之间并不直接关联，而是通过ZooKeeper上某个节点关联，减少系统耦合，如Storm。</p>
<p>ZooKeeper可以作为另外一种系统调度模式：某系统有控制台和推送系统两部分组成，控制台的职责是控制推送系统并进行相应的推送工作；管理人员在控制台的一些操作，实际上是修改ZooKeeper上某些节点的状态，而ZooKeeper就把这些变化通知给客户端，即推送系统，从而做出相应的推送任务。</p>
<p>ZooKeeper能够作为另外一种工作汇报模式：一些类似于任务分发系统，子任务启动后，到ZooKeeper来注册一个临时节点，并且定时将自己的进度进行汇报（将进度写到这个临时节点），这样任务管理者就能够实时知道任务进度。</p>
<h4 id="分布式队列"><a href="#分布式队列" class="headerlink" title="分布式队列"></a>分布式队列</h4><p>第一种队列，是常规的先进先出队列，这个和分布式锁服务中的控制时序场景一样，变通一下即可。</p>
<p>第二种队列，是等到队列成员聚齐以后才同意按序执行。典型场景是，分布式环境中一个大任务Task A，需要在很多子任务完成或条件就绪的情况下才能进行。这个时候，凡是其中一个子任务完成，那么就去/taskList下建立自己的临时有序节点。/taskList下会预先建立一个/taskList/num节点，并且复制为n，表示队列大小，每次有队列成员加入后，就判断下是否已经达到队列大小，决定是否可以开始执行了。当/taskList发现自己下面的子节点满足指定个数，就可以进行下一步按序进行处理了。</p>
<h2 id="ZooKeeper实现原理"><a href="#ZooKeeper实现原理" class="headerlink" title="ZooKeeper实现原理"></a>ZooKeeper实现原理</h2><p>首先，我们来看一下ZooKeeper的系统结构：</p>
<p><img src="http://s12.sinaimg.cn/large/0022QsiTzy6POld6B1Ffb" alt="" title="出处：http://zookeeper.apache.org/doc/trunk/zookeeperOver.html"></p>
<p>正如前面提到的，ZooKeeper的服务是通过一个集群进行提供，以增加可靠性。然而，可靠性增加带来的问题是如何保持一致性。</p>
<h3 id="一致性概念"><a href="#一致性概念" class="headerlink" title="一致性概念"></a>一致性概念</h3><p>一致性分为强一致性和弱一致性性。强一致性，要求读操作可以读到已提交的更新操作。弱一致性，提交的更新操作，不一定立即会被读操作读到，此种情况下，会存在一个不一致的窗口，即读操作可以读到最新值需要经过一段时间。</p>
<p>强一致性要求无论更新操作是在哪个数据副本上执行，之后所有的读操作都要能获得最新的数据。这当然是很理想的结果，然而追求强一致性意味着可用性不好，因为多副本间的同步需要耗费大量的网络传输和分布式锁​，用时很大，会导致读写操作需要阻塞更长的时间。</p>
<p>所以一般而言系统只实现弱一致性。最终一致性是一种典型的应用方案：事务更新一份数据，保证在没有其他事务更新同样的值的话，最终所有的事务都会读到之前事务更新的最新值——ZooKeeper是这种方案的一个开源实现。</p>
<h3 id="Paxos算法"><a href="#Paxos算法" class="headerlink" title="Paxos算法"></a>Paxos算法</h3><p>假设集群每个节点具有一致的初始状态，那么我们只需要保证在集群启动后，每个节点都执行相同的操作序列，那么它们最后能得到一个一致的状态。</p>
<p>Paxos算法的作用是，保证每个节点都执行相同的操作序列。ZooKeeper集群中有一台服务器是Leader，Leader维护一个全局的写队列，所有写操作都必须要放入这个队列编号，那么无论我们写多少个节点，只要写操作是按编号来的，就能保证一致性。</p>
<p>Paxos算法通过投票来对写操作进行全局编号，同一时刻，只有一个写操作被批准；并发的写操作要去争取选票，只有获得半数选票的写操作才会被批准，因此任意时刻永远只会有一个写操作被批准。其他写操作竞争失败只好再发起一轮投票。在不断的投票过程中，所有写操作都被严格编号排序。假设一台机器接受了编号为100的写操作，之后又接受到编号为99的写操作，它马上能意识到自己数据不一致了，自动停止对外服务并和Leader同步状态。</p>
<h3 id="Paxos算法白话版"><a href="#Paxos算法白话版" class="headerlink" title="Paxos算法白话版"></a>Paxos算法白话版</h3><blockquote>
<p>以下摘抄自：<a href="http://blog.csdn.net/cxhzqhzq/article/details/6568040​" target="_blank" rel="external">http://blog.csdn.net/cxhzqhzq/article/details/6568040​</a></p>
</blockquote>
<p>有一个叫做Paxos的小岛，上面住了一批居民，岛上所有事情都由一群议员做决定。议员的总数确定，不能更改。岛上每次环境事务的变更都需要通过一个提议Proposal，每个提议都有一个编号PID，该编号一直增长，不能倒退。每个提议都需要超过半数议员同意才能生效。每个议员只会同意大于当前编号的提议，包括已生效的和未生效的。如果议员收到小于等于当前编号的提议，他会拒绝，并告知对方：你的提议已经有人提过了。这里的当前编号是每个议员在自己记事本上面记录的编号，他不断更新这个编号。</p>
<p>最开始的时候，议员的记事本上记录编号都为0。有一个议员发了一个提议：将电费设定为1元/度。他首先看了下记事本，恩，当前编号为0，那么我的这个提议的编号就是1，于是他给所有议员发消息：1号提议，设定电费1元/度。其他议员收到消息后查了一下记事本，哦，当前编号是0，这个提议可接受，于是他记录下这个提议并回复：我接受你的1号提议；同时他在记事本上记录：当前提议编号为1。发起提议的议员收到了超过半数的回复，立即给所有人发通知：1号提议生效！收到的议员会修改他的记事本，将1号提议由记录改为法令，当有人问他电费多少时，他会查看法令并告知对方：1元/度。</p>
<p>现在来看看同时有多个提议提出的情况。假设总共有三个议员S1-S3，S1和S2同时发起了一个提议：1号提议，设定电费。S1想设为1元/度，S2想设为2元/度。结果S3先收到了S1提议，于是他做了和前面同样的操作。紧接着他又收到了S2的提议，结果他一查记事本，咦，这个提议的编号小于等于我的当前编号1，于是他拒绝了这个提议：对不起，这个提议先前提过了。于是S2的提议被拒绝。假设S1发布的提议同时也被S1接受了，那么S1获得了超过半数的支持，于是S1正式发布了提议：1号提议生效。S2向S1或者S3打听并更新了1号法令的内容，然后他可以选择继续发起2号提议。​</p>
<p>现在我们来一一对应Paxos算法与ZooKeeper的概念。下图是ZooKeeper的角色图，其中Observer可以先不管，后文会有介绍。​</p>
<p><img src="http://s9.sinaimg.cn/large/0022QsiTzy6POnjRtaMb8" alt="此处输入图片的描述" title="出处：http://www.cnblogs.com/lpshou/archive/2013/06/14/3136904.html"></p>
<p>议员——跟随者</p>
<p>居民——客户端​</p>
<p>提议——znode状态改变（创建、删除、更改等）</p>
<p>提议编号PID——Zxid（ZooKeeper Transaction ID）</p>
<p>正式法令——所有znode及其数据</p>
<p>ZooKeeper实现的算法叫做FastPaxos，与Paxos算法的区别在于所有的提议必须通过Leader（这里类比为Paxos小岛的总统）提出，如果议员有自己的提议，必须发给总统由总统来提出。</p>
<p>于是算法分为两个问题：一是怎么选出总统，这个后面再说；二是这个ZooKeeper议会怎么运转。</p>
<p><strong>Case 1</strong></p>
<p>居民甲（Client）到某个议员（ZK Server）那里询问（Get）某条法令的情况（ZNode的数据）​，议员毫不犹豫地拿出他的记事本（local storage），查阅法令并告诉他结果，同时声明：我的数据不一定是最新的。你想要最新的数据？没问题，等着，等我找总统Sync一下再告诉你。</p>
<p><strong>Case 2</strong></p>
<p>居民乙（Client）到某个议员（ZK Server）那里要求政府归还他的一万元，议员让他在办公室等着，自己将问题反映给了总统，总统询问所有议员的意见，多数议员表示欠钱要还，于是总统发表声明，从国库中拿出一万元还债，国库总资产由100万变成99万。居民乙拿着钱回去了（Client函数返回）</p>
<p><strong>Case 3</strong></p>
<p>总统突然驾崩了，议员接二连三地发现联系不上总统，于是各自发表声明，推选新的总统，总统大选期间政府停业，拒绝居民的请求。​​</p>
<p><strong>Leader选举算法</strong></p>
<p>这里讲解ZooKeeper的默认算法FastLeaderElection算法。</p>
<p>首先，需要了解ZooKeeper的服务器有以下几种状态：LOOKING寻找leader状态，LEADING领导状态，FOLLOWING跟随者状态，OBSERVING观察者状态。​</p>
<p>第二，选举过程需要进行多轮。每一轮选举中，机器会生成一张选票，然后群发给集群的其他机器。生成一张选票，那么机器保存的字段logicalClock/epoch会自增1。​</p>
<p>第三，每个机器选择Leader的逻辑是：每台机器有一个zxid和id；选主机器会优先选择zxid最大的机器，当zxid相同时，选择id最大的机器。</p>
<blockquote>
<p>算法的流程摘录自：<a href="http://blog.csdn.net/lovingprince/article/details/6826510" target="_blank" rel="external">http://blog.csdn.net/lovingprince/article/details/6826510</a></p>
</blockquote>
<p>FastLeaderElection. lookForLeader():</p>
<ol>
<li><p>logicalclock++，表示是新一轮leader选举，它是一个内存值，服务器重启就会导致该值归0，所以如果服务器活得越久，这个值随着应该越大，每一轮选举会保持所有机器该值始终是其中相同的最大值。</p>
</li>
<li><p>推举自己作为leader,并将自己服务器上存储的最大zxid，自己的服务器id,自己的状态(looking)notify所有的服务器，告知大家我想当leader.</p>
</li>
<li><p>等待其他服务器的反馈消息，如果有消息回来，分为以下几个情况：</p>
</li>
</ol>
<ul>
<li><p>自己还在looking,该消息标记的服务器也在looking<br>1) 消息的epoch&lt;自己的logicalclock，表示这条消息是前面一轮的消息，于是回发一条消息告诉对方当前的机器的logicalclock和推举的leader和zxid。<br>2) 消息epoch&gt;自己的logicalclock，表示对方已经开始新一轮选举了，更新logicalclock为epoch,清空接收到的所有服务器状态recvset.对比消息的zxid和本地的lastzxid，选取最大的作为leader，如果相同，则选取serverid最大的作为leader.然后sendNotifications()通知所有服务器我的选择。<br>3) 消息epoch=自己的logicalclock,表示是同一轮选举，对比消息的zxid和本地的lastzxid，选取最大的作为leader，如果相同，则选取serverid最大的作为leader.如果返回的消息是最后选择，则sendNotifications()通知所有服务器我的选择，否则不理睬这条消息，不发送任何回应。<br>经过上面的选择之后，(a) 如果收集到了所有服务器的投票，(b)如果此时收集的投票大于1/2服务器数，那么再等待一个时段，如果没有其他响应到来或者到来的响应没有新的选票产生。此时看下此时选举出来的proposedLeader是否是自己，是则更改自己的状态为leading,否则更改为following，然后跳出选举阶段。如果不满足上面的两条条件，则继续等待消息。</p>
</li>
<li><p>自己还在looking,该消息标记的服务器已经没有looking了<br>1) 消息的epoch=自己的logicalclock，如果消息状态是leading,那么就认为他是leading，更改自己的状态返回。如果消息认为自己是leader,那么需要有1/2以上服务器认为自己是leader,就更改状态并返回。<br>2) 消息的epoch&lt;&gt;自己的logicalclock，那么投票将加入到outofelection中，如果有1/2服务器以上的投票选择这条消息推荐的leader，那么更改自身的状态并返回。</p>
</li>
<li><p>自己没有looking,该消息标记的服务器还在looking<br>获得当前的leader信息，直接通知对方已经选择的leader.</p>
</li>
<li><p>自己没有looking,该消息标记的服务器没有looking<br>不做任何处理。</p>
</li>
</ul>
<p><strong>Observer与ZooKeeper的扩展</strong></p>
<blockquote>
<p>以下内容摘自：<a href="http://www.yanyufly.com/2011/04/29/转zookeeper的原理介绍/" target="_blank" rel="external">http://www.yanyufly.com/2011/04/29/转zookeeper的原理介绍/</a></p>
</blockquote>
<p>为了提高吞吐量通常我们只要增加服务器到Zookeeper集群中。但是当服务器增加到一定程度，会导致投票的压力增大从而使得吞吐量降低。因此我们引出了一个角色：Observer。</p>
<p>Observers 的需求源于 ZooKeeper  follower服务器在上述工作流程中实际扮演了两个角色。它们从客户端接受连接与操作请求，之后对操作结果进行投票。这两个职能在 ZooKeeper集群扩展的时候彼此制约。如果我们希望增加 ZooKeeper 集群服务的客户数量（我们经常考虑到有上万个客户端的情况），那么我们必须增加服务器的数量，来支持这么多的客户端。然而，从一致性协议的描述可以看到，增加服务器的数量增加了对协议的投票部分的压力。领导节点必须等待集群中过半数的服务器响应投票。于是，节点的增加使得部分计算机运行较慢，从而拖慢整个投票过程的可能性也随之提高，投票操作的会随之下降。这正是我们在实际操作中看到的问题——随着 ZooKeeper 集群变大，投票操作的吞吐量会下降。</p>
<p>所以需要增加客户节点数量的期望和我们希望保持较好吞吐性能的期望间进行权衡。要打破这一耦合关系，引入了不参与投票的服务器，称为 Observers。 Observers 可以接受客户端的连接，将写请求转发给领导节点。但是，领导节点不会要求 Observers 参加投票。相反，Observers 不参与投票过程，仅仅和其他服务节点一起得到投票结果。</p>
<p>这个简单的扩展给 ZooKeeper 的可伸缩性带来了全新的镜像。我们现在可以加入很多 Observers 节点，而无须担心严重影响写吞吐量。规模伸缩并非无懈可击——协议中的一歩（通知阶段）仍然与服务器的数量呈线性关系。但是，这里的穿行开销非常低。因此可以认为在通知服务器阶段的开销无法成为主要瓶颈。</p>
<p><strong>Follower与Leader处理读写请求</strong><br><img src="http://s10.sinaimg.cn/large/0022QsiTgy6POvKJOdza9" alt="此处输入图片的描述" title="出处：http://blog.csdn.net/xhh198781/article/details/10949697"></p>
<p><img src="http://s11.sinaimg.cn/large/0022QsiTgy6POvMogbM7a" alt="此处输入图片的描述" title="出处：http://blog.csdn.net/xhh198781/article/details/10949697"></p>
<h2 id="ZooKeeper的API"><a href="#ZooKeeper的API" class="headerlink" title="ZooKeeper的API"></a>ZooKeeper的API</h2><blockquote>
<p>以下摘抄自：<a href="http://www.cnblogs.com/yuyijq/p/4117634.html" target="_blank" rel="external">http://www.cnblogs.com/yuyijq/p/4117634.html</a></p>
</blockquote>
<p>Zookeeper的client是通过Zookeeper类提供的。Zookeeper的client api给我们提供以下这些API：</p>
<p><strong>create</strong><br>在给定的path上创建节点，这个path就像文件系统的路径，比如/myapp/data/1，在创建节点的时候还可以指定节点的类型：是永久节点，永久顺序节点，临时节点，临时顺序节点。这个节点类型是非常强大的。永久节点一经创建就永久保留了，就像我们在文件系统上创建一个普通文件，这个文件的生命周期跟创建它的应用没有任何关系。而临时节点呢，当创建这个临时节点的应用与zookeeper之间的会话过期之后就会被zookeeper自动删除了。这个特性是实现很多功能的关键。比如我们做集群感知，我们的应用启动的时候将自己的ip地址作为临时节点创建在某个节点下面。当我们的应用因为某些原因，比如网络断掉或者宕机，它与zookeeper的会话就会过期了，过期后这个临时节点就删除了。这样我们就可以通过这个特性来感知到我们的服务的集群有哪些机器是活者的。那么顺序节点又是什么呢。一般，如果我们在指定的path上创建节点，如果这个节点已经被创建了，则会抛出一个NodeExistsException的异常。如果我们在指定的路径上创建顺序节点，则Zookeeper会自动的在我们给定的path上加上一个顺序编号。这个特性就是实现分布式锁的关键。假设我们有几个节点共享一个资源，我们这几个节点都想争用这个资源，那我们就都向某个路径创建临时顺序节点。然后顺序最小的那个就获得锁，然后如果某个节点释放了锁，那顺序第二小的那个就获得锁，以此类推，这样一个分布式的公平锁就实现了。</p>
<p>除此之外，每个节点上还可以保存一些数据。</p>
<p><strong>delete</strong><br>删除给定节点。删除节点的时候还可以给定一个version，只有路径和version都匹配的时候节点才会被删除。有了这个version在分布式环境种我们就可以用乐观锁的方式来确保一致性。比如我们先读取一下节点，获得了节点的version，然后删除，如果删除成功了则说明在这之间没有人操作过这个节点，否则就是并发冲突了。</p>
<p><strong>exists</strong><br>这个节点会返回一个Stat对象，如果给定的path不存在的话则返回null。这个方法有一个关键参数，可以提供一个Watcher对象。Wathcer是Zookeeper强大功能的源泉。Watcher就是一个事件处理器，一个回调。比如这个exists方法，调用后，如果别人对这个path上的节点进行操作，比如创建，删除或设置数据，这个Wather都会接收到对应的通知。</p>
<p><strong>setData/getData</strong><br>设置或获取节点的数据，getData也可以设置Watcher</p>
<p><strong>getChildren</strong><br>获取子节点，可以设置Watcher</p>
<p><strong>sync</strong><br>zookeeper是一个集群，创建节点的时候只要半数以上的节点确认就认为是创建成功了，但是如果读取的时候正好读取到一个落后的节点上，那就有可能读取到旧的数据，这个时候可以执行一个sync操作，这个操作可以确保读取到最新的数据。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/08/逐层解构时间序列ARIMA模型/" itemprop="url">
                  逐层解构时间序列ARIMA模型
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-08T21:07:36+08:00" content="2015-12-08">
              2015-12-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/算法/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ARIMA模型的组成结构"><a href="#ARIMA模型的组成结构" class="headerlink" title="ARIMA模型的组成结构"></a>ARIMA模型的组成结构</h2><p><strong>ARIMA(p, d, q)</strong>由三个部分组成：</p>
<ul>
<li><strong>AR(p)</strong>：AR是autoregressive的缩写，表示自回归模型，含义是当前时间点的值等于过去若干个时间点的值的回归——因为不依赖于别的解释变量，只依赖于自己过去的历史值，故称为自回归；如果依赖过去最近的p个历史值，称阶数为p，记为AR(p)模型。</li>
<li><strong>I(d)</strong>：I是integrated的缩写，含义是模型对时间序列进行了差分；因为时间序列分析要求平稳性，不平稳的序列需要通过一定手段转化为平稳序列，一般采用的手段是差分；d表示差分的阶数，t时刻的值减去t-1时刻的值，得到新的时间序列称为1阶差分序列；1阶差分序列的1阶差分序列称为2阶差分序列，以此类推；另外，还有一种特殊的差分是季节性差分S，即一些时间序列反应出一定的周期T，让t时刻的值减去t-T时刻的值得到季节性差分序列。</li>
<li><strong>MA(q)</strong>：MA是moving average的缩写，表示移动平均模型，含义是当前时间点的值等于过去若干个时间点的预测误差的回归；预测误差=模型预测值-真实值；如果序列依赖过去最近的q个历史预测误差值，称阶数为q，记为MA(q)模型。</li>
</ul>
<p>I(d)很好理解，将不平稳序列差分得到平稳序列，略过不表。假设我们现在的时间序列已经是平稳的了。</p>
<p>AR(p)模型很好理解，一般而言，时间序列的变量具有时序上的相关性。比如说一条道路的速度，当时间间隔足够小时，上一个时间点速度如果慢，下一个时间点也往往很慢慢。这种内在的相关性，使得我们可以根据最近几个时间点的观测值来预测下几个时间点的值。</p>
<span>$Y_t = \epsilon_t + \beta_1Y_{t-1} + \beta_2Y_{t-2} + ... + \beta_pY_{t-p}$</span><!-- Has MathJax -->
<p>MA(q)模型是我在学习ARIMA时最难理解的地方。说白了，MA模型就是无穷阶AR模型的等价表示。为什么这么说？我们来看一个特殊的无穷阶的AR模型。</p>
<span>$Y_t = \epsilon_t + \beta Y_{t-1} - \beta^2Y_{t-2} + \beta^3Y_{t-3} - \beta^4Y_{t-4} + ...        (1)$</span><!-- Has MathJax -->
<p>将(1)中的t用t-1替代，得到(2)：</p>
<span>$Y_{t-1} = \epsilon_{t-1} + \beta Y_{t-2} - \beta^2Y_{t-3} + \beta^3Y_{t-4} - \beta^4Y_{t-5} + ...        (2)$</span><!-- Has MathJax -->
<p>将(2)的左右两边同乘<span>$\beta$</span><!-- Has MathJax -->:</p>
<span>$\beta Y_{t-1} = \beta\epsilon_{t-1} + \beta^2Y_{t-2} - \beta^3Y_{t-3} + \beta^4Y_{t-4} - \beta^5Y_{t-5} + ...       (3)$</span><!-- Has MathJax -->
<p>(1) + (2)，得到(4)：</p>
<span>$Y_t = \epsilon_t + \beta\epsilon_{t-1}        (4)$</span><!-- Has MathJax -->
<p>式(4)就是MA(1)。对比式(1)和式(4)，我们可以得到MA(1)相当于一个无穷阶的AR模型。同样的，对于任意的q，MA(q)均可以找到一个AR模型与之对应。因此，我们可以得到，时间序列数据归根到底，是可以用统一用AR模型来表示的。</p>
<p>那么，为什么还要MA模型呢？如果只有AR模型，那么一些时间序列必然会需要很高的阶数p来刻画。阶数p，就是待估参数的个数。待估参数越多，需要付出的参数估计代价就越大，所以我们当然希望参数个数越少越好。因此我们自然希望能够用低阶的MA模型来替换高阶的AR模型；反之亦然。</p>
<p>这也可以从自相关系数和偏自相关系数来理解。MA模型的阶数看自相关系数，AR模型的阶数看偏自相关系数。如果自相关系数q阶以后都趋于0，说明是MA(q)模型；这时去看偏自相关系数，必然是无穷阶后都不收敛于0——因为MA模型对应无穷阶的AR模型。同样的，如果偏自相关系数p阶以后都趋于0，说明是AR(p)模型；这时去看自相关系数，必然是无穷阶后都不收敛于0——因为AR模型对应无穷阶的MA模型。</p>
<p>最后，来说说ARMA模型。当自相关系数和偏自相关系数都没有收敛于0，说明这个时间序列不能纯用低阶的AR模型或者纯用低阶的MA模型来解释，需要低阶的AR和低阶的MA模型混合来解释。也可以换个角度来思考，前面提到，任何一个时间序列都可以用纯粹的AR模型来刻画。但是偏自相关系数无穷阶后都不收敛于0，说明只能用一个高阶的AR来解释。但这样的话，阶数太高，待估参数太多，我们就不开心了。所以我们对这个高阶AR模型做分解，分解出一个低阶的AR模型和另一个特殊的高阶AR模型，其中分解出来的高阶AR模型恰好等价于一个低阶的MA模型。于是我们就可以用低阶的AR模型和低阶的MA模型来描述这个时间序列了，这就是ARMA模型。</p>
<h2 id="ARIMA模型的实践心得"><a href="#ARIMA模型的实践心得" class="headerlink" title="ARIMA模型的实践心得"></a>ARIMA模型的实践心得</h2><p>个人觉得ARIMA里面的MA很让人讨厌，因为没有MA，ARIMA就是一个特殊的线性回归模型，可以用大量现成的线性回归包进行参数估计。来自杜克大学的一段关于ARIMA模型的论述很好地阐述了这个点：</p>
<blockquote>
<p>Predicted value of <em>Y = a constant and/or a weighted sum of one or more recent values of Y and/or a weighted sum of one or more recent values of the errors.</em><br><strong>If the predictors consist only of lagged values of Y, it is a pure autoregressive (“self-regressed”) model, which is just a special case of a regression model and which could be fitted with standard regression software.</strong>  For example, a first-order autoregressive (“AR(1)”) model for Y is a simple regression model in which the independent variable is just Y lagged by one period (LAG(Y,1) in Statgraphics or Y_LAG1 in RegressIt).  If some of the predictors are lags of the errors, an ARIMA model it is NOT a linear regression model, because there is no way to specify “last period’s error” as an independent variable:  the errors must be computed on a period-to-period basis when the model is fitted to the data.<br>出处：<a href="http://people.duke.edu/~rnau/411arim.htm" target="_blank" rel="external">http://people.duke.edu/~rnau/411arim.htm</a></p>
</blockquote>
<p>所以我的感觉是，能不用MA就不用MA，这样会让问题的实现变得简单很多，参数估计问题可以自行解决，而不用依赖专业的统计软件，如R、SAS、SPSS等。统计软件固然方便，但是不便于做模型的扩展。比如，我们做时间序列时，除了时间序列的观测值外，还希望加入别的解释变量。举我做过的一个例子，我们想预测一条路未来一个小时的路况，输入数据除了这条路过去的历史路况和当前路况外，还希望把上下游联系紧密的道路的历史路况和当前路况也加进来，即对时间序列做空间上的扩展，得到空间时间序列，在学术上被称为ST-ARIMA（Spatial Temporal ARIMA）。另外，我们知道时间序列的预测，说白了就是认为历史的行为在将来会复现，因此如果有突发情况，肯定是预测不准的。但是如果这种突发情况，我们是能够事先捕获，并作为输入，加入到预测模型里去，就可以很好地改善模型的预测效果；这本质的作用类似用突发情况，对时间序列的训练机做分组，从而让每组的参数不一样。举个具体的例子，北京会时不时实行下单双号限行，尾号还会定期轮换，这些因素都可以作为解释变量加入到模型中去。因此，采用AR模型的话，我们就可以方便地引入各种解释变量，对时间序列数据做拓展，以机器学习的思路来建模。</p>
<p>下面以Python为例介绍对AR模型进行工程实现的思路。</p>
<p>首先，确定下输入数据的格式，以道路速度预测为例，每隔10分钟一个数据，长相如下：</p>
<table>
<thead>
<tr>
<th>时间批次</th>
<th>道路索引</th>
<th>道路信息（实时速度，profile速度，关联系数）</th>
</tr>
</thead>
<tbody>
<tr>
<td>20150807180200</td>
<td>0</td>
<td>42, 40, 100</td>
</tr>
<tr>
<td>20150807180200</td>
<td>1</td>
<td>20, 43, 69</td>
</tr>
<tr>
<td>20150807180200</td>
<td>2</td>
<td>27, 40, 51</td>
</tr>
<tr>
<td>20150807181200</td>
<td>0</td>
<td>23, 45, 100</td>
</tr>
<tr>
<td>20150807181200</td>
<td>1</td>
<td>18, 50, 69</td>
</tr>
<tr>
<td>20150807181200</td>
<td>2</td>
<td>25, 47, 51</td>
</tr>
</tbody>
</table>
<p>下一步，要解决怎么在Python中表示时间序列。显然，我们可以用一个二级dict，让第一级的key是时间批次，第二级的key是道路索引，value是道路信息。</p>
<p>然后，我们要根据时间序列，生成机器学习的标准训练格式(label, feature)，因为我们往往想知道这组数据发生在什么时间，所以再加一个时间字段，输出为(t, label, feature)。伪代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ts_dict = 时间序列</span><br><span class="line">AR_P = AR模型的阶数</span><br><span class="line">NUM = 关联道路数</span><br><span class="line">final_list = []</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> range(start_time, stop_time, step_time):</span><br><span class="line">	<span class="keyword">if</span> ts_dict.has_key[t]:</span><br><span class="line">		<span class="keyword">if</span> ts_dict[t].has_key[<span class="number">0</span>]:</span><br><span class="line">			label = 道路信息</span><br><span class="line">			feature = &#123;&#125;</span><br><span class="line">			<span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>, AR_P+<span class="number">1</span>):</span><br><span class="line">				t_p = t - step_time * x</span><br><span class="line">				<span class="keyword">if</span> ts_dict.has_key[t_p]:</span><br><span class="line">					<span class="keyword">for</span> 道路索引,道路信息 <span class="keyword">in</span> ts_dict[t_p].iteritems()</span><br><span class="line">					idx = 道路索引 + x * NUM</span><br><span class="line">					feature[idx] = 道路信息</span><br><span class="line">			final_list.append((t, label, feature))</span><br></pre></td></tr></table></figure>
<p>这里面需要注意的是，feature的下标idx的公式。</p>
<p>整理成这样的格式后，可以用线性回归参数估计方法，得到AR模型的估计结果。事实上，整理成上述格式以后，我们已经可以不仅限于AR模型了，任何回归和分类模型都可以用上，如逻辑回归、支持向量机、决策树、随机森林、GBDT等。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/10/10/Spark入门与大数据处理技术比较/" itemprop="url">
                  Spark入门&大数据处理技术比较
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-10-10T07:07:36+08:00" content="2015-10-10">
              2015-10-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/大数据基础/" itemprop="url" rel="index">
                    <span itemprop="name">大数据基础</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="RDD的概念"><a href="#RDD的概念" class="headerlink" title="RDD的概念"></a>RDD的概念</h2><p>RDD是Spark的核心。关于它的定义，简单来说，就是能够保存在内存里的分布式数据集。官方定义如下：</p>
<blockquote>
<p>The main abstraction Spark provides is a <strong>resilient distributed dataset (RDD)</strong>, which is a collection of elements partitioned across the nodes of the cluster that can be operated on in parallel.<br>出处：<em>Spark Programming Guide</em></p>
</blockquote>
<p>对于Hadoop而言，分布式数据集是存储在文件系统HDFS上的，这样的坏处：数据处理往往需要多个MapReduce环节，下一个环节很可能依赖于上一个环节的输出；由于没有分布式内存机制，Hadoop必须把上一个环节MapReduce的输出结果写到硬盘HDFS上，下一个环节再从HDFS上读取。因此磁盘IO将会花费大量的时间。这种模式对于迭代式计算，如机器学习，非常不便。</p>
<p>Spark创造的RDD机制可以很好地解决这个问题。一般而言，Spark的流程如下：首先，从HDFS读取数据创建RDD；然后对RDD进行各种数据转换与处理的操作（可以简单理解为若干个Hadoop的MapReduce操作），直到得到满意的结果；最后，将结果写到HDFS，或者输出至屏幕。</p>
<p>如果把Spark的这个过程和Hadoop作对比，最大的区别就是用RDD替代了HDFS作为不同数据处理环节的媒介；当然，还有一个重要的区别，Hadoop只提供了Map和Reduce两种操作，Spark提供了更加灵活的操作方法，后面会有更详细的阐述。</p>
<h2 id="入门例子：wordcount"><a href="#入门例子：wordcount" class="headerlink" title="入门例子：wordcount"></a>入门例子：wordcount</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspark <span class="keyword">import</span> SparkContext</span><br><span class="line">sc = SparkContext(<span class="string">"local"</span>, <span class="string">"wordcount"</span>)</span><br><span class="line">textFile = sc.textFile(<span class="string">"YOUR_SPARK_HOME/README.md"</span>)</span><br><span class="line">wordCounts = textFile.flatMap(<span class="keyword">lambda</span> line: line.split()).map(<span class="keyword">lambda</span> word: (word, <span class="number">1</span>)).reduceByKey(<span class="keyword">lambda</span> a, b: a+b)</span><br><span class="line"><span class="keyword">print</span> wordCounts.collect()</span><br></pre></td></tr></table></figure>
<p>代码剖析如下：</p>
<ol>
<li>导入Python使用的Spark包</li>
<li>初始化Spark环境，”local”表示程序用单机模拟Spark，”wordcount”是Spark程序的名字，这个名字会显示在Spark的集群管理页面</li>
<li><strong>textFile()</strong>用于从文件系统读取数据，生成RDD</li>
<li><strong>flatMap()</strong>将RDD的每一行按照参数定义的函数转化为多行，<em>lambda</em>定义了Python的匿名函数，函数输入是line，输出是line.split()；<strong>map()</strong>将RDD的每一行按照参数定义的函数转化为一行，(word, 1)表示一个键值对，word为key，1为value；<strong>reduceByKey()</strong>将RDD按照key分组后，按照参数定义的函数进行合并，此处函数的作用是是分组求和</li>
<li><strong>collect()</strong>，将RDD的数据，从集群的各个节点收集回提交任务的机器，放在单机内存里</li>
</ol>
<h2 id="RDD-Operations和持久化"><a href="#RDD-Operations和持久化" class="headerlink" title="RDD Operations和持久化"></a>RDD Operations和持久化</h2><p>关于RDD的Operations可以分为两类，一类是<strong>transformation</strong>，作用是从一个RDD转变成新的RDD，如例子中的flatMap()，map()，reduceByKey()；一类是<strong>action</strong>，对RDD做计算，把结果返回给提交任务的机器，如例子中的collect()。值得注意的是，所有的transformation都是<em>lazy</em>机制，即transformation不会立刻执行，只是被程序记住要执行这个操作，直到碰到action时，才按照记录的操作顺序触发数据处理流程。</p>
<p>每个action触发计算时，相关的transformation会重新计算；可以用<strong>persist()</strong>在内存中保存中间RDD，这样下次action触发时，就可以从persist后的RDD开始，节省计算时间。如果要释放空间，可以调用<strong>unpersist()</strong>。</p>
<h2 id="大数据数据处理技术比较"><a href="#大数据数据处理技术比较" class="headerlink" title="大数据数据处理技术比较"></a>大数据数据处理技术比较</h2><p>个人认为，SQL是数据处理的典范。评价一个数据处理工具最好的方法就是拿工具提供的功能和SQL进行对比。下面是我个人对Hive、Spark和Hadoop三个技术的比较。</p>
<table>
<thead>
<tr>
<th><strong>Hive</strong></th>
<th><strong>Spark</strong></th>
<th><strong>Hadoop</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>where</td>
<td><strong>filter()</strong></td>
<td>Map</td>
</tr>
<tr>
<td>join</td>
<td><strong>join()</strong></td>
<td>MapReduce</td>
</tr>
<tr>
<td>group by</td>
<td><strong>groupByKey()</strong></td>
<td>MapReduce</td>
</tr>
<tr>
<td>distribute by, sort by, cluster by</td>
<td><strong>repartitionAndSortWithinPartitions(partitioner)</strong></td>
<td>Shuffle</td>
</tr>
<tr>
<td>distinct</td>
<td><strong>distinct()</strong></td>
<td>MapReduce</td>
</tr>
<tr>
<td>udf</td>
<td><strong>map()</strong></td>
<td>Map</td>
</tr>
<tr>
<td>udaf</td>
<td><strong>reduce()</strong></td>
<td>Map</td>
</tr>
<tr>
<td>udtf</td>
<td><strong>flatMap()</strong></td>
<td>Map</td>
</tr>
<tr>
<td>动态分区</td>
<td>原生API不支持, 版本号1.5.2</td>
<td>MapReduce</td>
</tr>
</tbody>
</table>
<p>Hadoop是Hive实现的基础，所有Hive撰写的SQL代码最终都会转化为底层的MapReduce作业。所以Hadoop是支持所有SQL需要的功能。问题在于，Hadoop就只提供了Map和Reduce的编程接口，这是非常底层的一个接口。本质上，Map和Reduce是一样的，就是一个自定义函数，告诉Hadoop怎么处理用户的数据；如果这个自定义函数不需要shuffle，那么就是Map；如果这个自定义函数之前需要shuffle，那么就是Reduce。</p>
<p>然而，不管用户的数据长什么样子，数据处理的模式就那几种，基本都涵盖在SQL的关键字表达里。Hive简单来讲，就是在底层先用MapReduce实现了可复用的SQL各种关键字对应的数据处理模式，在顶层提供给用户一个类SQL的编程接口，在中间通过一个解析器把顶层用户撰写的SQL语句转变为对底层可复用的MapReduce代码的调用。</p>
<p>Spark的批处理模式与Hadoop在理念上是一致的，也是MapReduce模型，也提供了shuffle机制；不同的是，用RDD替换了HDFS作为数据处理环节的媒介。另一方面，Spark与Hive类似，提供了比Hadoop MapReduce丰富得多的数据处理模式，即RDD的Operations，基本上与Hive SQL提供的功能相同。</p>
<h2 id="Spark和Hadoop的shuffle比较"><a href="#Spark和Hadoop的shuffle比较" class="headerlink" title="Spark和Hadoop的shuffle比较"></a>Spark和Hadoop的shuffle比较</h2><p>此处需专门拉出一文讨论，可先参考我同事做的这个笔记<a href="http://xialeizhou.com/2015/12/08/Spark-Shuffle%E8%AF%A6%E8%A7%A3/" target="_blank" rel="external">Spark Shuffle详解</a>。总的来讲，我感觉是两个大区别：</p>
<ul>
<li>Map端：Hadoop现在是一个mapper输出一个文件；Spark是一个mapper输出R个文件，R为reducer的个数。</li>
<li>Reduce端：Hadoop从Map端抓来属于自己分组的数据后，会做一次强制的merge sort；Spark从Map端抓来属于自己分组的数据后，不强制做sort。Hadoop强制做了merge sort的好处是，相同key的数据会被reducer一次性连续访问完，因此做reduce操作时只需record by record地聚合，而不用消耗内存；坏处是，并不是所有的reduce操作都需要按照key进行排序。Spark的优劣势反之，不排序的后果是在做reduce时，必须在内存开一个dict来存聚合的结果，对内存消耗大，可能撑爆内存。</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>Spark在理念上和Hadoop如出一辙，都是基于MapReduce的思想，基于shuffle的。一方面，Spark实现了绝大部分数据处理会用到的MapReduce模式，提供了更丰富的语义接口供用户调用，使得用户在完成相同的数据处理流程时撰写的代码量大幅度减少。另一方面，Spark独创的RDD使中间结果能够放在内存中而不用写到HDFS，这样减少了IO时间的消耗，数据处理延时低，除了批处理应用场景外，还适合迭代式计算（Spark MLlib, Spark GraphX）、交互式数据处理（Spark SQL）、实时数据处理（Spark Streaming）。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/10/03/R数据分析进阶05：阿里云rodps/" itemprop="url">
                  R数据分析进阶05：阿里云ODPS
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-10-03T13:14:21+08:00" content="2015-10-03">
              2015-10-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/R数据分析进阶/" itemprop="url" rel="index">
                    <span itemprop="name">R数据分析进阶</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="RODPS安装"><a href="#RODPS安装" class="headerlink" title="RODPS安装"></a>RODPS安装</h3><p>ODPS package依赖rJava和RSQLite，因此如果rJava还没有安装的话系统会提示首先要安装rJava和RSQLite, 可以用以下命令安装</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">install.packages(c(<span class="string">'rJava'</span>,<span class="string">'RSQLite'</span>))</span><br></pre></td></tr></table></figure>
<p>默认镜像如果访问不了，可以使用以下命令切换至国内的镜像，如切换至北交大镜像。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setRepositories(addURLs=c(CRANxtras=<span class="string">"http://mirror.bjtu.edu.cn/cran/"</span>))</span><br></pre></td></tr></table></figure>
<p>用以下命令安装ODPS包</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">install.packages(<span class="string">'RODPS'</span>,repos=<span class="string">'http://odps.alibaba-inc.com/rodps'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="RODPS访问配置"><a href="#RODPS访问配置" class="headerlink" title="RODPS访问配置"></a>RODPS访问配置</h3><p>创建配置文件odps_config.ini，填入对应的信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">project_name=$YOUR_PROJECT</span><br><span class="line">access_id=$YOUR_ACCESS_ID</span><br><span class="line">access_key=$YOUR_ACCESS_KEY</span><br><span class="line">end_point=$ODPS_END_POINT</span><br><span class="line">dt_end_point=$DT_END_POINT</span><br></pre></td></tr></table></figure></p>
<p>在程序中使用以下命令初始化RODPS环境</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">library</span>(<span class="string">"RODPS"</span>)</span><br><span class="line">rodps.init(path=<span class="string">"$YOUR_PATH/odps_config.ini"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="RODPS代码模板"><a href="#RODPS代码模板" class="headerlink" title="RODPS代码模板"></a>RODPS代码模板</h3><p>R语言的弱点在于不能操作海量的数据，ODPS是阿里云大数据平台，通过SQL语句处理TB级、PB级数据毫无压力。ODPS的存储基础是表，与R的数据框对应，都是结构化的数据，因此可以很好衔接。一般情况下，用R进行海量数据分析的工作流程是：首先用SQL从大表里统计得到小表，然后将小表加载到R的数据框里。用原生态的RODPS函数，实现这个流程比较琐碎，因此集成了一个函数load.odps.sql，只要传入project和sql的select语句，就能把select的结果存为数据框。</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">library</span>(<span class="string">"RODPS"</span>)</span><br><span class="line">rodps.init(path=<span class="string">"$YOUR_PATH/odps_config.ini"</span>)</span><br><span class="line">rodps.use.project(projectname = <span class="string">"$YOUR_PROJECT"</span>)</span><br><span class="line"><span class="comment"># self-defined function: transform the sql result to data frame</span></span><br><span class="line">load.odps.sql &lt;- <span class="keyword">function</span>(project,sql)&#123;</span><br><span class="line">  table_name &lt;- paste0(project,<span class="string">".tmpttttttttttttcsp"</span>)</span><br><span class="line">  sql_cmd &lt;- paste(<span class="string">"create table if not exists"</span>, table_name, <span class="string">"as"</span>, sql)</span><br><span class="line">  rodps.query(sql_cmd)</span><br><span class="line">  df &lt;- rodps.load.table(table_name)</span><br><span class="line">  sql_drop_cmd = paste(<span class="string">"drop table if exists"</span>, table_name, <span class="string">";"</span>) </span><br><span class="line">  rodps.query(sql_drop_cmd)</span><br><span class="line">  <span class="keyword">return</span>(df)</span><br><span class="line">&#125;</span><br><span class="line">project &lt;- <span class="string">"$YOUR_PROJECT"</span></span><br><span class="line">sql_cmd &lt;- <span class="string">"YOUR_SQL_SELECT_CMD"</span></span><br><span class="line">df &lt;- load.odps.sql(project, sql_cmd)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/09/10/R数据分析进阶04：reshape2/" itemprop="url">
                  R数据分析进阶04：reshape2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-09-10T23:10:58+08:00" content="2015-09-10">
              2015-09-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/R数据分析进阶/" itemprop="url" rel="index">
                    <span itemprop="name">R数据分析进阶</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文只考虑数据框的相关操作，主要是两个函数<strong>melt()</strong>和<strong>dcast()</strong>。</p>
<p>讲义需要的案例：</p>
<p><strong>表1：长形式</strong></p>
<table>
<thead>
<tr>
<th>车辆</th>
<th>道路等级</th>
<th>日均覆盖里程</th>
</tr>
</thead>
<tbody>
<tr>
<td>车辆1</td>
<td>高速</td>
<td>100</td>
</tr>
<tr>
<td>车辆2</td>
<td>高速</td>
<td>111</td>
</tr>
<tr>
<td>车辆1</td>
<td>快速路</td>
<td>125</td>
</tr>
<tr>
<td>车辆2</td>
<td>快速路</td>
<td>110</td>
</tr>
<tr>
<td>车辆1</td>
<td>主要道路</td>
<td>30</td>
</tr>
<tr>
<td>车辆2</td>
<td>主要道路</td>
<td>76</td>
</tr>
</tbody>
</table>
<p><strong>表2：宽形式</strong></p>
<table>
<thead>
<tr>
<th>车辆</th>
<th>高速覆盖里程</th>
<th>快速路覆盖里程</th>
<th>主要道路覆盖里程</th>
</tr>
</thead>
<tbody>
<tr>
<td>车辆1</td>
<td>100</td>
<td>125</td>
<td>30</td>
</tr>
<tr>
<td>车辆2</td>
<td>111</td>
<td>110</td>
<td>76</td>
</tr>
</tbody>
</table>
<h3 id="melt"><a href="#melt" class="headerlink" title="melt"></a>melt</h3><p><strong>使用场景</strong>：当数据框的几个列可以被归纳为某一个大类别时：比如列1为高速路，列2为快速路，列3为主要道路，这三列可以归结为一列道路等级。<br><strong>案例</strong>：将表2变为表1<br><strong>语法介绍</strong><br><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">melt(data, id.vars, measure.vars, </span><br><span class="line">	variable.name=<span class="string">"variable"</span>, <span class="keyword">...</span> , </span><br><span class="line">	na.rm=<span class="literal">FALSE</span>, value.name=<span class="string">"value"</span>)</span><br></pre></td></tr></table></figure></p>
<ul>
<li>id.vars：每个变量在结果中占一列</li>
<li>measure.vars：被当成观测值的列变量，列变量名称和值分别组成”variable”和”value”两列</li>
</ul>
<p><strong>案例应用</strong></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">table1 &lt;- melt(table2, id.vars=c(<span class="string">"车辆"</span>), </span><br><span class="line">	measure.vars=c(<span class="string">"高速覆盖里程"</span>, </span><br><span class="line">		<span class="string">"快速路覆盖里程"</span>, </span><br><span class="line">		<span class="string">"主要道路覆盖里程"</span>), </span><br><span class="line">	variable.name=<span class="string">"道路等级"</span>, </span><br><span class="line">	value.name=<span class="string">"日均覆盖里程"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="dcast"><a href="#dcast" class="headerlink" title="dcast"></a>dcast</h3><p><strong>使用场景</strong>：数据框的某一个列可以拆分为多个小类别时：比如道路等级可以拆分为三列：高速路，快速路，主要道路；函数还需要指定拆出来的三列的值来自哪里。<br><strong>案例</strong>：将表1变为表2<br><strong>语法介绍</strong></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dcast(data, formula, <span class="keyword">...</span>, value.var = guess_value(data))</span><br></pre></td></tr></table></figure>
<ul>
<li>formula: 以~为分割，左边的变量在整形后依然作为变量，右边的变量的取值拆为新的变量名，e.g. diet + chick ~ time</li>
<li>value.var: 新的变量名下的取值，需要加双引号</li>
</ul>
<p><strong>案例应用</strong><br><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">table2 &lt;- dcast(table1, 车辆~道路等级，</span><br><span class="line">	value.var=<span class="string">"日均覆盖里程"</span>)</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/09/01/R数据分析进阶03：plyr/" itemprop="url">
                  R数据分析进阶03：plyr
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-09-01T18:49:11+08:00" content="2015-09-01">
              2015-09-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/R数据分析进阶/" itemprop="url" rel="index">
                    <span itemprop="name">R数据分析进阶</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文只考虑基于数据框的操作，所指函数是ddply.</p>
<h3 id="基本思想"><a href="#基本思想" class="headerlink" title="基本思想"></a>基本思想</h3><p>plyr包数据打理模型是”分割-应用-结合“.<br><strong>ddply()</strong>函数输入一个数据框，返回一个数据框——这就是ddply()函数前两个字母”dd“的含义：输入一个data frame，输出一个data frame。</p>
<h3 id="语法介绍"><a href="#语法介绍" class="headerlink" title="语法介绍"></a>语法介绍</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ddply(data, group_vars, summarize OR transform, new_var = <span class="keyword">function</span>(param_var))</span><br></pre></td></tr></table></figure>
<ul>
<li>group_vars: 用于作为分割基准的变量，有两种形式，一种是c(“var1”, “var2”)，一种是.(var1, var2)；如果取值为NULL，表示对整个数据框作用函数。</li>
<li>summarize OR transform:  如果采用summarize，新的数据框，只会包含group_vars和new_var；如果采用transform，新的数据框会保留原始的数据框的所有列，new_var会在相同分组的不同行重复填上相同的结果。</li>
<li>new_var = function(param_var)：允许使用多个函数。e.g. highestMargin = max(margin), lowestMargin = min(margin)</li>
</ul>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>请参考网上的这个优秀资料<br><a href="http://developer.51cto.com/art/201312/423612_all.htm" target="_blank" rel="external">http://developer.51cto.com/art/201312/423612_all.htm</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="丹追兵" />
          <p class="site-author-name" itemprop="name">丹追兵</p>
          <p class="site-description motion-element" itemprop="description">刚出道的大数据分析师</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">12</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">丹追兵</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  



  
  
  

  



<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
</body>
</html>
